(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{388:function(s,a,t){s.exports=t.p+"assets/img/image-20200629154905635.3116b8f5.png"},399:function(s,a,t){"use strict";t.r(a);var n=t(20),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"应用与集群管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#应用与集群管理"}},[s._v("#")]),s._v(" 应用与集群管理")]),s._v(" "),n("p",[s._v("本章主要介绍应用与集群相关的一些操作管理命令，包括关闭、重置、开启服务，还有建立集群的一些信息。有关集群搭建请参考后续的「RabbitMQ 运维」章节")]),s._v(" "),n("h2",{attrs:{id:"应用管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#应用管理"}},[s._v("#")]),s._v(" 应用管理")]),s._v(" "),n("h3",{attrs:{id:"停止运行-stop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#停止运行-stop"}},[s._v("#")]),s._v(" 停止运行 stop")]),s._v(" "),n("p",[s._v("用于停止运行 RabbitMQ 和 Erlang 虚拟机。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl stop "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pid_file"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n参数：\n\tpid_file：通过 rabbitmq-server 命令启动 RabbitMQ 服务创建的。默认情况存放与 rabbitmq安装目录/var/lib/rabbitmq/mnesia 目录下；可以通过 RABBITMQ_PID_FILE 环境变量来改变存放路径。\n\t\t\t  注意：通过 rabbitmq-server --detach 这个后缀命令启动不会生成 pid_file 文件\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("实践练习")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意啊，我们通过 rabbitmq-server -detached 后台运行启动的")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以通过它来停止，而且写一个错误的路径也可以停止运行")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过下面讲解的 shutdown 命令，可以看到这个 pid 或许不是真正的 pid 文件")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 因为在启动的时候打印了 Warning: PID file not written; -detached was passed.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mnesia"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl stop /opt/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@study.pid")]),s._v("\nStopping and halting node rabbit@study\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"停止运行-shutdown"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#停止运行-shutdown"}},[s._v("#")]),s._v(" 停止运行 shutdown")]),s._v(" "),n("p",[s._v("用于停止运行 RabbitMQ 和 Erlang 虚拟机。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行该指令会阻塞知道 Erlang 虚拟机进程退出。如果 RabbitMQ 没有成功关闭，则会返回一个非零值。")]),s._v(" "),n("p",[s._v("与 stop 不同的是，不需要指定 pid_file，而且可以阻塞等待指定进程的关闭")]),s._v(" "),n("p",[s._v("实践练习")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mnesia"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl shutdown")]),s._v("\nShutting down RabbitMQ node rabbit@study running at PID "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19531")]),s._v("\nWaiting "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" PID "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19531")]),s._v(" to terminate\nRabbitMQ node rabbit@study running at PID "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19531")]),s._v(" successfully shut down\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"停止-rabbitmq-服务应用：stop-app"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#停止-rabbitmq-服务应用：stop-app"}},[s._v("#")]),s._v(" 停止 RabbitMQ 服务应用：stop_app")]),s._v(" "),n("p",[s._v("停止 RabbitMQ 服务应用，但是 Erlang 虚拟机还是处于运行状态。此命令的执行优先于其他管理操作（这些管理操作需要先停止 RabbitMQ 应用），比如 rabbitmqct reset")]),s._v(" "),n("p",[s._v("实践练习")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mnesia"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl stop_app")]),s._v("\nStopping rabbit application on node rabbit@study\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"启动-rabbitmq-服务应用：start-app"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动-rabbitmq-服务应用：start-app"}},[s._v("#")]),s._v(" 启动 RabbitMQ 服务应用：start_app")]),s._v(" "),n("p",[s._v("该命令的典型应用场景是：在执行了其他的管理操作之后，重新启动之前停止的 RabbitMQ 应用，比如 rabbitmqct reset")]),s._v(" "),n("p",[s._v("实践练习")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mnesia"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl start_app")]),s._v("\nStarting node rabbit@study\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"等待-rabbitmq-应用的启动：wait"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#等待-rabbitmq-应用的启动：wait"}},[s._v("#")]),s._v(" 等待 RabbitMQ 应用的启动：wait")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wait")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pid_file"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("等待 RabbitMQ 应用的启动。它会 "),n("strong",[s._v("等到 pid_file 的创建")]),s._v("，然后 "),n("strong",[s._v("等待 pid_file 中所代表的进程启动")]),s._v("。当指定的进程没有启动 RabbitMQ 应用而关闭时将返回失败。")]),s._v(" "),n("p",[s._v("实践练习")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study mnesia"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl wait /opt/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@study.pid")]),s._v("\nWaiting "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" rabbit@study\npid is "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18130")]),s._v("\nError: process_not_running\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 前面讲到启动时，有一个警告 Warning: PID file not written; ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在这里也能证明出来，的确没有写入。这个 18130 可能是最开始笔者不小心直接执行了 rabbitmq-server 创建的")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"重置-rabbitmq-节点：reset"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#重置-rabbitmq-节点：reset"}},[s._v("#")]),s._v(" 重置 RabbitMQ 节点：reset")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl reset\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将 RabbitMQ 节点重置还原到最初状态。包括从 "),n("strong",[s._v("原来所在的集群中删除此节点")]),s._v("，从管理数据库中删除所有的配置数据，如已配置的用户、vhost 等。以及删除所有的持久化消息。")]),s._v(" "),n("p",[n("strong",[s._v("执行该命令前必须停止 RabbitMQ 应用")]),s._v("，比如先执行 "),n("code",[s._v("rabbitmqctl stop_app")])]),s._v(" "),n("p",[s._v("这里笔者就不尝试实践了，只有一个节点")]),s._v(" "),n("h3",{attrs:{id:"强制重置-rabbitmq-节点：force-reset"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#强制重置-rabbitmq-节点：force-reset"}},[s._v("#")]),s._v(" 强制重置 RabbitMQ 节点：force_reset")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl force_reset\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("与 reset 类似，不过它无论当前管理数据库的状态和集群配置是什么，都会无条件的重置节点。"),n("strong",[s._v("只能在数据库或集群配置已损坏的情况下使用")]),s._v("。")]),s._v(" "),n("h3",{attrs:{id:"配置轮换日志文件：rotate-logs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置轮换日志文件：rotate-logs"}},[s._v("#")]),s._v(" 配置轮换日志文件：rotate_logs")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl rotate_logs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("suffix"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("配置 RabbitMQ 节点轮换日志文件。RabbitMQ 节点会将原来的日志文件中的内容追加到「原始名称 + 后缀」的日志文件中，然后再将新的日志内容记录到新创建的日志文件中（与原日志同名）。")]),s._v(" "),n("p",[s._v("当目标文件不存在时，会重新创建。如果不指定 suffix 后缀，则日志文件只是重新打开而不会进行轮换。")]),s._v(" "),n("p",[s._v("实践练习")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入到日志目录")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /opt/rabbitmq/var/log/rabbitmq/")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\n总用量 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("59781")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" 06:04 rabbit@study.log\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":23 rabbit@study-sasl.log\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行轮换操作")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl rotate_logs .1")]),s._v("\nRotating logs to files with suffix "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('".1"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\n总用量 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" 06:17 rabbit@study.log\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("59856")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" 06:17 rabbit@study.log.1\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" 06:17 rabbit@study-sasl.log\n-rw-r--r--. "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("月  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" 06:17 rabbit@study-sasl.log.1\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以看到原来的文件被归档了一样。")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h3",{attrs:{id:"编译：hipe-compile"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编译：hipe-compile"}},[s._v("#")]),s._v(" 编译：hipe_compile")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl hipe_compile "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("directory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将部分 RabbitMQ 代码用 HiPE 编译，并将编译后的 "),n("code",[s._v(".beam")]),s._v(" 文件保存到指定的文件目录中。如果该目录不存在则会创建，如果存在，则先删除里面的任何 "),n("code",[s._v(".beam")]),s._v(" 文件。")]),s._v(" "),n("p",[s._v("如果要使用预编译的这些文件，则需要设置 "),n("code",[s._v("RABBITMQ_SERVER_CODE_PATH")]),s._v(" 环境变量来指定 hipe_compile 调用的路径")]),s._v(" "),n("p",[s._v("名词解释：")]),s._v(" "),n("ul",[n("li",[s._v("HiPE：High Performance Erlang，是 Erlang 版的 JIT 编译")]),s._v(" "),n("li",[n("code",[s._v(".beam")]),s._v("  ：是 Erlang 编译器生成的文件格式，可以直接加载到 Erlang 虚拟机中运行的文件格式")])]),s._v(" "),n("p",[s._v("如下所示")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl hipe_compile /opt/rabbitmq/tmp/rabbit-hipe/ebin")]),s._v("\n\nHiPE compiling:  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("---------------------------------------------------------"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n                 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#########################################################|")]),s._v("\n\nCompiled "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),s._v(" modules "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 221s\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("虽然知道有啥用处，指定的新目录里面的确多了很多 "),n("code",[s._v(".beam")]),s._v("ni c 文件")]),s._v(" "),n("h2",{attrs:{id:"集群管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#集群管理"}},[s._v("#")]),s._v(" 集群管理")]),s._v(" "),n("p",[s._v("这里只列出来命令，具体的使用详见后续章节 RabbitMQ 运维;")]),s._v(" "),n("h3",{attrs:{id:"加入集群：join-cluster"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加入集群：join-cluster"}},[s._v("#")]),s._v(" 加入集群：join_cluster")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl join_cluster "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("cluster_node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--ram"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将节点计入指定集群中")]),s._v(" "),n("h3",{attrs:{id:"集群状态：cluster-status"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#集群状态：cluster-status"}},[s._v("#")]),s._v(" 集群状态：cluster_status")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl cluster_status\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("显示集群状态。")]),s._v(" "),n("h3",{attrs:{id:"修改集群节点类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改集群节点类型"}},[s._v("#")]),s._v(" 修改集群节点类型")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl change_cluster_node_type "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("disc "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ram")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改集群节点的类型，修改之前需要停止 RabbitMQ 引用")]),s._v(" "),n("h3",{attrs:{id:"删除集群节点：forget-cluster-node"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#删除集群节点：forget-cluster-node"}},[s._v("#")]),s._v(" 删除集群节点：forget_cluster_node")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl forget_cluster_node "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("--offline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将节点从集群中删除，允许离线执行。")]),s._v(" "),n("h3",{attrs:{id:"更新集群信息：update-cluster-nodes"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#更新集群信息：update-cluster-nodes"}},[s._v("#")]),s._v(" 更新集群信息：update_cluster_nodes")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl update_cluster_nodes "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("clusternode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("在集群中的节点应用启动前咨询 clusternode 节点的最新信息，并更新相应的集群信息；")]),s._v(" "),n("p",[n("strong",[s._v("与 join_cluster 不同，它不加入集群")]),s._v("；如这种情况：")]),s._v(" "),n("ul",[n("li",[s._v("节点 A 和节点 B 在集群中，")]),s._v(" "),n("li",[s._v("当节点 A 离线了，节点 C 又和 节点 B 组成了一个集群，")]),s._v(" "),n("li",[s._v("然后节点 B 又离开了集群")])]),s._v(" "),n("p",[s._v("当节点 A 醒来时，它会尝试联系节点 B，但是这样会失败，因为节点 B 已经不在集群中了。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl update_cluster_nodes -n A C \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("使用以上命令，可解决这种场景下出现的问题。")]),s._v(" "),n("h3",{attrs:{id:"确保节点可以启动：force-boot"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#确保节点可以启动：force-boot"}},[s._v("#")]),s._v(" 确保节点可以启动：force_boot")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl force_boot\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("确保节点可以启动，即使它不是最后一个关闭的节点。")]),s._v(" "),n("p",[s._v("通常情况下，"),n("strong",[s._v("当关闭整个 RabbitMQ 集群时")]),s._v("，"),n("strong",[s._v("重启的第一个节点")]),s._v(" "),n("strong",[s._v("应该是最后关闭的节点")]),s._v("，因为它可以看到其他节点所看不到的事情。但是有时候会出现一些异常情况，比如整个集群都断电，所有节点都不是最后一个关闭的。")]),s._v(" "),n("p",[s._v("在这种情况下就可以使用该命令告诉节点可以无条件启动。")]),s._v(" "),n("p",[s._v("在此节点关闭后，集群的任何变化，都会丢失。如果最后一个关闭的节点永久丢失了，那么需要优先使用")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl forget_cluster_node --offline\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("因为他可以确保镜像队列的正常运转。")]),s._v(" "),n("h3",{attrs:{id:"同步镜像队列内容：sync-queue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同步镜像队列内容：sync-queue"}},[s._v("#")]),s._v(" 同步镜像队列内容：sync_queue")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl sync_queue "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-p vhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("queue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("指定 "),n("strong",[s._v("未同步队列 queue 的 slave 镜像可以同步 master 镜像行的内容")]),s._v("。同步期间此队列会被阻塞（所有此队列的生产消息都会被阻塞），直到同步完成。")]),s._v(" "),n("p",[s._v("**前提是：**配置了 queue 镜像")]),s._v(" "),n("p",[s._v("注意：未同步队列中的消息被消耗尽后，最终也会变成同步，此命令主要用于未耗尽的队列。（详见后组章节 RabbitMQ 高阶）")]),s._v(" "),n("h3",{attrs:{id:"取消镜像队列同步：cancel-sync-queue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#取消镜像队列同步：cancel-sync-queue"}},[s._v("#")]),s._v(" 取消镜像队列同步：cancel_sync_queue")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl cancel_sync_queue "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("-p vhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("queue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"设置集群名称：set-cluster-name"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#设置集群名称：set-cluster-name"}},[s._v("#")]),s._v(" 设置集群名称：set_cluster_name")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("rabbitmqctl set_cluster_name "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("设置集群名称。")]),s._v(" "),n("p",[s._v("集群名称在客户端连接时会通报给客户端。Federation 和 Shovel 插件也会有用到集群名的地方，详细内容参考后续章节 跨越集群的界限")]),s._v(" "),n("p",[n("strong",[s._v("集群名称 默认是集群中第一个节点的名称")]),s._v("，通过该命令重新设置。在 web 管理界面右上角有可以修改，如下图")]),s._v(" "),n("p",[n("img",{attrs:{src:t(388),alt:"image-20200629154905635"}})]),s._v(" "),n("p",[s._v("通过集群状态也能查看到当前的集群名称")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@study rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmqctl cluster_status")]),s._v("\nCluster status of node rabbit@study\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("nodes,"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("disc,"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rabbit@study"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("running_nodes,"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rabbit@study"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("cluster_name,"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rabbit@study"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("partitions,"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("alarms,"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("rabbit@study,"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个是没有操作过集群的，默认就是个单节点的集群")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);