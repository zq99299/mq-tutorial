#  RabbitMQ 简介

RabbitMQ 是目前非常热门的一款 **消息中间件**，不管是互联网行业还是传统行业都在大量使用。它具有高可靠、易扩展、高可用及丰富的功能特性。

## 什么是消息中间件

**消息（Message）**：在应用层传送的数据。比如文本字符串、JSON 等。

**消息队列中间件（Message Queue Middleware，MQ）**：利用 **可靠的消息传递机制** 进行 **与平台无关的数据交流**，并基于数据通信来进行分布式系统的集成。通过消息排队模型，它可以在 **分布式环境下扩展进程间的通信**。

消息队列中间件一般有两种传递模式：

- 点对点（P2P，Point-to-Point）模式

  基于 **队列**，消息生产者发送消息到队列，消息消费者从队列中接收消息。

  队列的存在使得消息的 **异步传输**成 为可能。

- 发布/订阅（Pub/Sub）模式

  定义了如何向一个内容节点发布和订阅消息，内容节点称为 **主题（topic）**，消息发布者将消息 **发布到某个主题**，而消息订阅者则 **从主题中订阅消息**。

  该模式在 **消息的一对多广播时采用**

消息中间件适用于需要可靠的数据传送的分布式环境。发送者将消息发送给消息服务器，消息服务器将 **消息存放在若干队列中**，在合适的时候再将消息 **转发给接收者**。实现应用程序之间的协同，优点在于能够在客户和服务器之间提供同步和异步的链接，并且在任何时刻都可以将消息进行传送或存储转发。

![image-20200622175343455](./assets/image-20200622175343455.png)

例如上图：A、B程序使用消息中间件进行通信。程序 A、B 可以不在同一台服务器上，A 发送消息给 B，消息中间件负责处理网络通信，如果网络连接不可用，会存储消息，直到连接变得可用，再将消息转发给 B。

灵活的体现在于：程序 B 可以不在线，A 也能投递消息，防止 A 等待 B 处理出现的阻塞。

## 消息中间件的作用

在不同的应用场景下有不同的作用，总的来说，可以概括如下：

- 解耦

  对于项目的变化，很难预测到未来的变动。消息中间件在处理过程中间插入了一个隐含、基于数据的接口层，两边的处理过程都要实现这一接口，但是两边都可以独立的扩展或则修改自己的处理过程，只要 **确保他们遵守同样的接口约束** 即可。

- 冗余（存储）

  某些情况下，处理数据的过程可能失败。消息中间件可以把数据持久化直到他们已经被完全处理，通过这一方式 **规避了数据丢失的风险**。

  在把一个消息从中间件删除时，需要你明确的指出该消息已经被处理完成。

- 扩展性

  因为 **解耦了应用程序的处理过程**，所以 **提高消息入队** 和 **处理效率** 就变得很容易了，只要增加额外的处理过程即可，不需要改变代码和参数

- 削峰

  在访问量剧增的场景下，应用需要继续发挥作用，但是这样的突然流量并不常见。如果以能处理这类峰值为标准而投入资源（比如硬件），无疑是巨大的浪费。使用消息中间件能够使关键组件支持突发访问压力，不会因为突发的超负荷请求而完全崩溃。

- 可恢复性

  当系统一部分组件失效时，不会影响到整个系统。当这部分组件被修复后，再连接上消息中间件，可以继续处理未处理完的消息。

- 顺序保证

  大多数场景下，数据处理的顺序很重要，大部分消息中间件支持一定程度上的顺序性。

- 异步通信

  在很多时候，应用不想也不需要立即处理消息。将消息放入消息中间件中，但并不立即处理它，在之后需要的时候再慢慢处理。

## RabbitMQ 的起源

RabbitMQ 是采用 Erlang 语言实现 **AMQP（Advanced Message Queuing Protocol）高级消息队列协议** 的消息中间件，最初起源于金融系统，用于在 **分布式系统中存储转发消息**。

商业 MQ 供应商想要解决 **应用互通** 的问题，而不是去创建标准来实现不同的 MQ 产品间的互通，或则运行应用程序更改 MQ 平台。价格高昂、还不通用。

为了解决这种困境，**JMS（Java Message Service）** 就应运而生。JMS 试图通过提供 **公共 Java API**  的方式，隐藏单独 MQ 产品供应商提供的时实际接口，解决了互通问题。从技术上讲：只要针对 JMS API 编程，选择合适的 MQ 驱动，JMS 会打理好其他的部分。**ActiveMQ** 就是 JMS 的一种实现。由于 JMS 使用单独标准化接口来胶合众多不同的接口，最终会暴露出问题，使得程序变得脆弱。急需一种新的消息通信标准化方案。

2006 年 6 月，由 Cisco、Redhat、iMatix 等联合制定了 AMQP 的公开标准，它是 **应用层协议的一个开放标准**，以解决众多消息中间件的需求和拓扑结构问题。它为 **面向消息的中间件** 设计，基于此协议的客户端与消息中间件可传递消息，并 **不受产品、开放语言等条件的限制**。

RabbitMQ 最初版本实现了 AMQP 的一个关键特性：使用协议本身就可以对队列和交换器（Exchange）这样的资源进行配置。而商业 MQ 则需要特定的管理终端。RabbitMQ 的资源配置能力使其成为构建分布式应用的最完美的通信总线。

Rabbit 英译为兔子，含义为：兔子行动非常迅速且繁殖起来非常疯狂。因此使用 RabbitMQ 来命名这个分布式软件。

RabbitMQ 发展到今天，被越来越多人认可，这和它在易用性、扩展性、可靠性和高可用性等方面的卓越表现是分不开的。具体特点可以概括为以下几点：

- 可靠性：使用一些机制来保证可靠性

  如：持久化、**传输确认**、**发布确认**等。

- 灵活的路由：在消息进入队列之前，通过 **交换器** 来 **路由** 消息

  对于典型的路由功能，提供了 **内置的交换器** 来实现。针对复杂的路由功能，可以 **将多个交换器绑定在一起**，也可以通过 **插件机制** 来实现自己的交换器

- 扩展性：多个 RabbitMQ 节点可以组成一个集群，也可以动态扩展集群节点。

- 高可用性：

  **队列** 可以在集群中的机器上设置 **镜像**，使得在部分节点出现问题的情况下，队列仍然可用。

- 多种协议：原生支持 AMQP 协议

  还支持 STOMP、MQTT 等多种消息中间件协议
  
- 多语言客户端：支持常用语言客户端

  如：Java、Python、Ruby、PHP、`C#`、JavaScript

- 管理界面

  提供了一个易用的用户界面，使得用户可以 **监控和管理消息、集群中的节点** 等

- 插件机制：

  提供了许多插件，以实现从多方面进行扩展，也可以自己编写插件。

## RabbitMQ 的安装及简单使用

先介绍 RabbitMQ 的安装过程，然后演示发送和消费消息的具体实现。

本书如无特指，所有程序都在 Linux 下运行。

### 安装 Erlang

前面说到过，RabbitMQ 是由 Erlang 语言编写的， 需要先下载；本书采用 [19.x 版本](https://www.erlang.org/downloads/19.3)。[下载链接](http://erlang.org/download/otp_src_19.3.tar.gz)


